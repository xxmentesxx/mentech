<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Robot Kontrolü</title>
    <style>
        /* Stil kodları (öncekiyle aynı) */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background: linear-gradient(to bottom right, #1a202c, #2d3748);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            color: #fff;
        }
        .container {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 28rem;
            border: 1px solid #4a5568;
        }
        h1 {
            font-size: 1.875rem; /* 3xl */
            font-weight: bold;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #fff;
        }
        .status-display {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #4a5568;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
        }
        .status-display p {
            margin: 0;
            color: #cbd5e0; /* gray-300 */
            font-size: 1.125rem; /* lg */
            margin-bottom: 0.5rem;
        }
        .status-display .status-text {
            color: #48bb78; /* green-400 */
            font-size: 1.5rem; /* 2xl */
            font-weight: 600; /* semibold */
        }
        .message-text {
            color: #90cdf4; /* blue-300 */
            font-size: 0.875rem; /* sm */
            margin-top: 0.5rem;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            justify-items: center; /* Butonları hücre içinde ortala */
            align-items: center; /* Butonları hücre içinde dikeyde ortala */
        }
        .button {
            background-color: #4299e1; /* blue-600 */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
            transform: scale(1);
            cursor: pointer;
            border: none;
            outline: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none; /* added for anchor tags if used */
            width: 100%; /* Butonların hücreyi doldurmasını sağla */
            height: 100%; /* Butonların hücreyi doldurmasını sağla */
            min-height: 60px; /* Minimum yükseklik */
        }
        .button:hover {
            background-color: #3182ce; /* blue-700 */
            transform: scale(1.05);
        }
        .button:active {
            transform: scale(0.98);
        }
        .button:focus {
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5), 0 0 0 6px rgba(66, 153, 225, 0.25);
        }
        .button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button svg {
            height: 1.5rem; /* h-6 */
            width: 1.5rem; /* w-6 */
            margin-bottom: 0.25rem; /* mb-1 */
            stroke: currentColor;
            stroke-width: 2;
        }
        .button.red {
            background-color: #e53e3e; /* red-600 */
        }
        .button.red:hover {
            background-color: #c53030; /* red-700 */
        }
        .button.purple {
            background-color: #805ad5; /* purple-600 */
        }
        .button.purple:hover {
            background-color: #6b46c1; /* purple-700 */
        }
        .button.green {
            background-color: #38a169; /* green-600 */
        }
        .button.green:hover {
            background-color: #2f855a; /* green-700 */
        }
        .button.yellow {
            background-color: #d69e2e; /* yellow-600 */
        }
        .button.yellow:hover {
            background-color: #b7791f; /* yellow-700 */
        }
        /* Grid Pozisyonları */
        .grid-item-top { grid-column: 2 / 3; grid-row: 1 / 2; }
        .grid-item-left { grid-column: 1 / 2; grid-row: 2 / 3; }
        .grid-item-center { grid-column: 2 / 3; grid-row: 2 / 3; }
        .grid-item-right { grid-column: 3 / 4; grid-row: 2 / 3; }
        .grid-item-bottom { grid-column: 2 / 3; grid-row: 3 / 4; }

        .input-area {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #4a5568;
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
        }
        .input-area h2 {
            font-size: 1.25rem; /* xl */
            font-weight: bold;
            color: #fff;
            margin-bottom: 1rem;
        }
        .input-area textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #1a202c; /* gray-900 */
            color: #fff;
            border: 1px solid #4a5568; /* gray-600 */
            outline: none;
            box-sizing: border-box; /* padding'in width'i etkilememesi için */
        }
        .input-area textarea:focus {
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5), 0 0 0 6px rgba(66, 153, 225, 0.25);
        }
        .info-text {
            color: #a0aec0; /* gray-400 */
            font-size: 0.875rem; /* sm */
            text-align: center;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32 Robot Kontrolü</h1>

        <div class="status-display">
            <p>Mevcut Durum:</p>
            <p id="robotStatus" class="status-text">Durduruldu</p>
            <p id="apiMessage" class="message-text"></p>
        </div>

        <div class="control-grid">
            <button class="button grid-item-top"
                    onmousedown="startMove('İleri')" ontouchstart="startMove('İleri')"
                    onmouseup="stopMove()" ontouchend="stopMove()"
                    id="forwardBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                </svg>
                İleri
            </button>

            <button class="button purple grid-item-left"
                    onmousedown="startMove('Sola Dön')" ontouchstart="startMove('Sola Dön')"
                    onmouseup="stopMove()" ontouchend="stopMove()"
                    id="leftBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0M3 12h18" />
                </svg>
                Sol
            </button>

            <button class="button red grid-item-center" onclick="sendMovementCommand('Durduruldu')" id="stopBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                </svg>
                Dur
            </button>

            <button class="button purple grid-item-right"
                    onmousedown="startMove('Sağa Dön')" ontouchstart="startMove('Sağa Dön')"
                    onmouseup="stopMove()" ontouchend="stopMove()"
                    id="rightBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 9l3 3m0 0l-3 3m3-3H6m18 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Sağ
            </button>

            <button class="button grid-item-bottom"
                    onmousedown="startMove('Geri')" ontouchstart="startMove('Geri')"
                    onmouseup="stopMove()" ontouchend="stopMove()"
                    id="backwardBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
                Geri
            </button>
        </div>

        <div class="input-area">
            <h2>✨ Akıllı Yol Planlayıcı</h2>
            <textarea id="pathInput" rows="3" placeholder="Örn: ileri 2 saniye, sonra sağa dön 1 saniye, sonra dur."></textarea>
            <button class="button green" style="width: 100%; margin-top: 1rem;" onclick="generatePathPlan()" id="planBtn">
                Yol Planı Oluştur ve Yürüt
            </button>
        </div>

        <div class="input-area">
            <h2>✨ Yaratıcı Hareket Önerisi</h2>
            <button class="button yellow" style="width: 100%;" onclick="generateCreativeMovement()" id="creativeBtn">
                Yaratıcı Bir Hareket Önerisi Al
            </button>
        </div>

        <p class="info-text">
          Bu uygulama, ESP32 tabanlı bir robot için basit bir kontrol arayüzü demosudur. Gerçek robot kontrolü için ESP32'de uygun firmware ve ağ iletişimi (Wi-Fi, Bluetooth) gereklidir. Yapay zeka destekli özellikler, Gemini API'si kullanılarak metin komutlarını robot hareketlerine dönüştürür.
        </p>
    </div>

    <script>
        const ESP32_BASE_URL = 'https://4553-176-233-25-111.ngrok-free.app'; 
        const GEMINI_API_KEY = "AIzaSyA-BZAMWG3oNvTybh1LY-St6Xoo4KC-E_E"; 

        const robotStatusElement = document.getElementById('robotStatus');
        const apiMessageElement = document.getElementById('apiMessage');
        const pathInput = document.getElementById('pathInput');
        const forwardBtn = document.getElementById('forwardBtn');
        const backwardBtn = document.getElementById('backwardBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const stopBtn = document.getElementById('stopBtn');
        const planBtn = document.getElementById('planBtn');
        const creativeBtn = document.getElementById('creativeBtn');

        let isLoading = false; 

        function setStatus(status, message = '') {
            robotStatusElement.textContent = status;
            apiMessageElement.textContent = message;
        }

        function setButtonsDisabled(disabled) {
            forwardBtn.disabled = disabled;
            backwardBtn.disabled = disabled;
            leftBtn.disabled = disabled;
            rightBtn.disabled = disabled;
            stopBtn.disabled = disabled;
            planBtn.disabled = disabled;
            creativeBtn.disabled = disabled;
            pathInput.disabled = disabled;
            isLoading = disabled; 
        }

        async function sendMovementCommand(direction) {
            setStatus(direction, `Robot komutu gönderiliyor: ${direction}`);
            
            try {
                const response = await fetch(`${ESP32_BASE_URL}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ direction: direction }),
                });

                if (response.ok) {
                    setStatus(direction, `Komut başarıyla gönderildi: ${direction}`);
                    console.log(`Robot hareketi: ${direction}`);
                } else {
                    const errorText = await response.text();
                    setStatus(direction, `Komut gönderilemedi: ${response.status} - ${errorText}`);
                    console.error(`ESP32'ye komut gönderilirken hata: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                setStatus('Hata!', `Ağ hatası: ${error.message}. Robot sunucusuna ulaşılamıyor olabilir.`);
                console.error('Ağ hatası:', error);
            }
        }

        async function startMove(direction) {
            if (isLoading) return; 
            await sendMovementCommand(direction);
        }

        async function stopMove() {
            if (isLoading) return; 
            await sendMovementCommand('Durduruldu');
        }

        async function executeCommands(commands) {
            setButtonsDisabled(true); 
            for (let i = 0; i < commands.length; i++) {
                const { command, duration_ms } = commands[i];
                setStatus(command, `${command} komutu yürütülüyor...`);
                await sendMovementCommand(command); 
                if (command !== 'Durduruldu') { 
                    await new Promise(resolve => setTimeout(resolve, duration_ms || 1000)); 
                }
            }
            await sendMovementCommand('Durduruldu'); 
            setStatus('Durduruldu', 'Tüm komutlar tamamlandı.');
            setButtonsDisabled(false); 
        }

        async function generatePathPlan() {
            if (!pathInput.value.trim()) {
                setStatus(robotStatusElement.textContent, 'Lütfen bir yol tarifi girin.');
                return;
            }

            setButtonsDisabled(true);
            setStatus(robotStatusElement.textContent, 'Yol planı oluşturuluyor...');

            try {
                const prompt = `Kullanıcı şu robot hareketini istiyor: "${pathInput.value}". Bu isteği bir dizi komuta dönüştür. Her komut "İleri", "Geri", "Sola Dön", "Sağa Dön" veya "Durduruldu" olmalı. Her komut için bir 'duration_ms' (milisaniye cinsinden süre) belirt. Örneğin, "ileri 2 saniye, sonra sağa dön 1 saniye, sonra dur". Eğer süre belirtilmezse varsayılan olarak 1000ms kullan. Yanıtı JSON formatında ver.`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { 
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "command": { "type": "STRING", "enum": ["İleri", "Geri", "Sola Dön", "Sağa Dön", "Durduruldu"] },
                                    "duration_ms": { "type": "INTEGER" }
                                },
                                "required": ["command"]
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedCommands = JSON.parse(jsonText); 
                    setStatus(robotStatusElement.textContent, 'Yol planı başarıyla oluşturuldu. Yürütülüyor...');
                    await executeCommands(parsedCommands); 
                } else {
                    setStatus(robotStatusElement.textContent, 'Yol planı oluşturulamadı. Lütfen tekrar deneyin.');
                    console.error('API yanıt yapısı beklenenden farklı:', result);
                }
            } catch (error) {
                setStatus('Hata!', `API hatası: ${error.message}`);
                console.error('Yol planı oluşturulurken hata oluştu:', error);
            } finally {
                setButtonsDisabled(false);
            }
        }

        async function generateCreativeMovement() {
            setButtonsDisabled(true);
            setStatus(robotStatusElement.textContent, 'Yaratıcı hareket önerisi alınıyor...');

            try {
                const prompt = `Bir robot için 3-5 adımdan oluşan kısa ve yaratıcı bir hareket dizisi oluştur. Her adım "İleri", "Geri", "Sola Dön", "Sağa Dön" veya "Durduruldu" komutlarından biri olmalı ve her komut için 500ms ile 2000ms arasında rastgele bir 'duration_ms' (milisaniye cinsinden süre) belirt. Yanıtı JSON formatında ver.`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { 
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "command": { "type": "STRING", "enum": ["İleri", "Geri", "Sola Dön", "Sağa Dön", "Durduruldu"] },
                                    "duration_ms": { "type": "INTEGER" }
                                },
                                "required": ["command", "duration_ms"]
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedCommands = JSON.parse(jsonText);
                    setStatus(robotStatusElement.textContent, 'Yaratıcı hareket önerisi alındı. Yürütülüyor...');
                    await executeCommands(parsedCommands);
                } else {
                    setStatus(robotStatusElement.textContent, 'Yaratıcı hareket önerisi oluşturulamadı. Lütfen tekrar deneyin.');
                    console.error('API yanıt yapısı beklenenden farklı:', result);
                }
            } catch (error) {
                setStatus('Hata!', `API hatası: ${error.message}`);
                console.error('Yaratıcı hareket oluşturulurken hata oluştu:', error);
            } finally {
                setButtonsDisabled(false);
            }
        }
    </script>
</body>
</html>
