<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Robot KontrolÃ¼</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background: linear-gradient(to bottom right, #1a202c, #2d3748);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            color: #fff;
        }
        .container {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 28rem;
            border: 1px solid #4a5568;
        }
        h1 {
            font-size: 1.875rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #fff;
        }
        .status-display {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #4a5568;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
        }
        .status-display p {
            margin: 0;
            color: #cbd5e0;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }
        .status-display .status-text {
            color: #48bb78;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .message-text {
            color: #90cdf4;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            justify-items: center;
            align-items: center;
        }
        .button {
            background-color: #4299e1;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
            transform: scale(1);
            cursor: pointer;
            border: none;
            outline: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            width: 100%; /* Ana kontrol butonlarÄ± iÃ§in %100 geniÅŸlik */
            height: 100%;
            min-height: 60px;
        }
        .button:hover {
            background-color: #3182ce;
            transform: scale(1.05);
        }
        .button:active {
            transform: scale(0.98);
        }
        .button:focus {
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5), 0 0 0 6px rgba(66, 153, 225, 0.25);
        }
        .button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button svg {
            height: 1.5rem;
            width: 1.5rem;
            margin-bottom: 0.25rem;
            stroke: currentColor;
            stroke-width: 2;
        }
        .button.red {
            background-color: #e53e3e;
        }
        .button.red:hover {
            background-color: #c53030;
        }
        .button.purple {
            background-color: #805ad5;
        }
        .button.purple:hover {
            background-color: #6b46c1;
        }
        .button.green {
            background-color: #38a169;
        }
        .button.green:hover {
            background-color: #2f855a;
        }
        .button.yellow {
            background-color: #d69e2e;
        }
        .button.yellow:hover {
            background-color: #b7791f;
        }
        /* Grid PozisyonlarÄ± */
        .grid-item-top { grid-column: 2 / 3; grid-row: 1 / 2; }
        .grid-item-left { grid-column: 1 / 2; grid-row: 2 / 3; }
        .grid-item-center { grid-column: 2 / 3; grid-row: 2 / 3; }
        .grid-item-right { grid-column: 3 / 4; grid-row: 2 / 3; }
        .grid-item-bottom { grid-column: 2 / 3; grid-row: 3 / 4; }

        .input-area {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #4a5568;
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
            text-align: center; /* Ä°Ã§indeki butonlarÄ± ortalamak iÃ§in */
        }
        .input-area h2 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 1rem;
        }
        .input-area textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #1a202c;
            color: #fff;
            border: 1px solid #4a5568;
            outline: none;
            box-sizing: border-box;
        }
        .input-area textarea:focus {
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5), 0 0 0 6px rgba(66, 153, 225, 0.25);
        }
        .info-text {
            color: #a0aec0;
            font-size: 0.875rem;
            text-align: center;
            margin-top: 2rem;
        }

        /* Yeni: Input alanlarÄ± iÃ§indeki butonlar iÃ§in Ã¶zel stil */
        .input-area .button {
            width: auto; /* GeniÅŸliÄŸi iÃ§eriÄŸe gÃ¶re ayarla */
            min-height: 40px; /* Minimum yÃ¼ksekliÄŸi azalt */
            padding: 0.5rem 1.5rem; /* Dolguyu azalt */
            font-size: 0.875rem; /* YazÄ± boyutunu kÃ¼Ã§Ã¼lt */
            display: inline-flex; /* Ä°Ã§eriÄŸe gÃ¶re geniÅŸlemesini saÄŸla ve ortalanabilir yap */
            margin-top: 0.5rem; /* Ãœst boÅŸluÄŸu koru */
        }
        .input-area .button svg {
            height: 1.25rem; /* Ä°kon boyutunu kÃ¼Ã§Ã¼lt */
            width: 1.25rem;
            margin-bottom: 0.125rem; /* Ä°kon alt boÅŸluÄŸunu azalt */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32 Robot KontrolÃ¼</h1>

        <div class="status-display">
            <p>Mevcut Durum:</p>
            <p id="robotStatus" class="status-text">Durduruldu</p>
            <p id="apiMessage" class="message-text"></p>
        </div>

        <div class="control-grid">
            <button class="button grid-item-top"
                    onmousedown="startMove('Ä°leri')" ontouchstart="startMove('Ä°leri')"
                    onmouseup="stopMove()" ontouchend="stopMove()"
                    id="forwardBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                </svg>
                Ä°leri
            </button>

            <button class="button purple grid-item-left"
                    onmousedown="startMove('Sola DÃ¶n')" ontouchstart="startMove('Sola DÃ¶n')"
                    onmouseup="stopMove()" ontouchend="stopMove()"
                    id="leftBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0M3 12h18" />
                </svg>
                Sol
            </button>

            <button class="button red grid-item-center" onclick="sendMovementCommand('Durduruldu')" id="stopBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                </svg>
                Dur
            </button>

            <button class="button purple grid-item-right"
                    onmousedown="startMove('SaÄŸa DÃ¶n')" ontouchstart="startMove('SaÄŸa DÃ¶n')"
                    onmouseup="stopMove()" ontouchend="stopMove()"
                    id="rightBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 9l3 3m0 0l-3 3m3-3H6m18 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                SaÄŸ
            </button>

            <button class="button grid-item-bottom"
                    onmousedown="startMove('Geri')" ontouchstart="startMove('Geri')"
                    onmouseup="stopMove()" ontouchend="stopMove()"
                    id="backwardBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
                Geri
            </button>
        </div>

        <div class="input-area">
            <h2>ðŸ’¡ Farlar</h2>
            <button class="button yellow" onclick="toggleHeadlights()" id="headlightsBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4.228 4.228l.707.707M1.636 18.364l.707-.707M12 21v-1m-6.364-1.636l.707-.707M3 12H2m15.364 4.364l.707.707M12 3a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" />
                </svg>
                FarlarÄ± AÃ§ / Kapat
            </button>
        </div>

        <div class="input-area">
            <h2>âœ¨ AkÄ±llÄ± Yol PlanlayÄ±cÄ±</h2>
            <textarea id="pathInput" rows="3" placeholder="Ã–rn: ileri 2 saniye, sonra saÄŸa dÃ¶n 1 saniye, sonra dur."></textarea>
            <button class="button green" onclick="generatePathPlan()" id="planBtn">
                Yol PlanÄ± OluÅŸtur ve YÃ¼rÃ¼t
            </button>
        </div>

        <div class="input-area">
            <h2>âœ¨ YaratÄ±cÄ± Hareket Ã–nerisi</h2>
            <button class="button yellow" onclick="generateCreativeMovement()" id="creativeBtn">
                YaratÄ±cÄ± Bir Hareket Ã–nerisi Al
            </button>
        </div>

        <p class="info-text">
          Bu uygulama, ESP32 tabanlÄ± bir robot iÃ§in basit bir kontrol arayÃ¼zÃ¼ demosudur. GerÃ§ek robot kontrolÃ¼ iÃ§in ESP32'de uygun firmware ve aÄŸ iletiÅŸimi (Wi-Fi, Bluetooth) gereklidir. Yapay zeka destekli Ã¶zellikler, Gemini API'si kullanÄ±larak metin komutlarÄ±nÄ± robot hareketlerine dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
        </p>
    </div>

    <script>
        const ESP32_BASE_URL = 'https://4220-176-233-25-111.ngrok-free.app'; 
        const GEMINI_API_KEY = "AIzaSyA-BZAMWG3oNvTybh1LY-St6Xoo4KC-E_E"; 

        const robotStatusElement = document.getElementById('robotStatus');
        const apiMessageElement = document.getElementById('apiMessage');
        const pathInput = document.getElementById('pathInput');
        const forwardBtn = document.getElementById('forwardBtn');
        const backwardBtn = document.getElementById('backwardBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const stopBtn = document.getElementById('stopBtn');
        const planBtn = document.getElementById('planBtn');
        const creativeBtn = document.getElementById('creativeBtn');
        const headlightsBtn = document.getElementById('headlightsBtn');

        let isLoading = false; 
        let headlightsOn = false; 

        function setStatus(status, message = '') {
            robotStatusElement.textContent = status;
            apiMessageElement.textContent = message;
        }

        function setButtonsDisabled(disabled) {
            forwardBtn.disabled = disabled;
            backwardBtn.disabled = disabled;
            leftBtn.disabled = disabled;
            rightBtn.disabled = disabled;
            stopBtn.disabled = disabled;
            planBtn.disabled = disabled;
            creativeBtn.disabled = disabled;
            pathInput.disabled = disabled;
            headlightsBtn.disabled = disabled;
            isLoading = disabled; 
        }

        async function sendMovementCommand(direction) {
            setStatus(direction, `Robot komutu gÃ¶nderiliyor: ${direction}`);
            
            try {
                const response = await fetch(`${ESP32_BASE_URL}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ direction: direction }),
                });

                if (response.ok) {
                    setStatus(direction, `Komut baÅŸarÄ±yla gÃ¶nderildi: ${direction}`);
                    console.log(`Robot hareketi: ${direction}`);
                } else {
                    const errorText = await response.text();
                    setStatus(direction, `Komut gÃ¶nderilemedi: ${response.status} - ${errorText}`);
                    console.error(`ESP32'ye komut gÃ¶nderilirken hata: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                setStatus('Hata!', `AÄŸ hatasÄ±: ${error.message}. Robot sunucusuna ulaÅŸÄ±lamÄ±yor olabilir.`);
                console.error('AÄŸ hatasÄ±:', error);
            }
        }

        async function toggleHeadlights() {
            if (isLoading) return;

            setButtonsDisabled(true); 
            const newState = !headlightsOn; 
            setStatus('Farlar', `Farlar ${newState ? 'aÃ§Ä±lÄ±yor' : 'kapanÄ±yor'}...`);

            try {
                const response = await fetch(`${ESP32_BASE_URL}/lights`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state: newState ? 'on' : 'off' }),
                });

                if (response.ok) {
                    headlightsOn = newState; 
                    setStatus('Farlar', `Farlar baÅŸarÄ±yla ${newState ? 'aÃ§Ä±ldÄ±' : 'kapandÄ±'}.`);
                    console.log(`Farlar: ${newState ? 'AÃ§Ä±k' : 'KapalÄ±'}`);
                } else {
                    const errorText = await response.text();
                    setStatus('Farlar', `Farlar komutu gÃ¶nderilemedi: ${response.status} - ${errorText}`);
                    console.error(`Farlar komutu gÃ¶nderilirken hata: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                setStatus('Hata!', `AÄŸ hatasÄ±: ${error.message}. Robot sunucusuna ulaÅŸÄ±lamÄ±yor olabilir.`);
                console.error('AÄŸ hatasÄ±:', error);
            } finally {
                setButtonsDisabled(false); 
            }
        }


        async function startMove(direction) {
            if (isLoading) return; 
            await sendMovementCommand(direction);
        }

        async function stopMove() {
            if (isLoading) return; 
            await sendMovementCommand('Durduruldu');
        }

        async function executeCommands(commands) {
            setButtonsDisabled(true); 
            for (let i = 0; i < commands.length; i++) {
                const { command, duration_ms } = commands[i];
                setStatus(command, `${command} komutu yÃ¼rÃ¼tÃ¼lÃ¼yor...`);
                await sendMovementCommand(command); 
                if (command !== 'Durduruldu') { 
                    await new Promise(resolve => setTimeout(resolve, duration_ms || 1000)); 
                }
            }
            await sendMovementCommand('Durduruldu'); 
            setStatus('Durduruldu', 'TÃ¼m komutlar tamamlandÄ±.');
            setButtonsDisabled(false); 
        }

        async function generatePathPlan() {
            if (!pathInput.value.trim()) {
                setStatus(robotStatusElement.textContent, 'LÃ¼tfen bir yol tarifi girin.');
                return;
            }

            setButtonsDisabled(true);
            setStatus(robotStatusElement.textContent, 'Yol planÄ± oluÅŸturuluyor...');

            try {
                const prompt = `KullanÄ±cÄ± ÅŸu robot hareketini istiyor: "${pathInput.value}". Bu isteÄŸi bir dizi komuta dÃ¶nÃ¼ÅŸtÃ¼r. Her komut "Ä°leri", "Geri", "Sola DÃ¶n", "SaÄŸa DÃ¶n" veya "Durduruldu" olmalÄ±. Her komut iÃ§in bir 'duration_ms' (milisaniye cinsinden sÃ¼re) belirt. Ã–rneÄŸin, "ileri 2 saniye, sonra saÄŸa dÃ¶n 1 saniye, sonra dur". EÄŸer sÃ¼re belirtilmezse varsayÄ±lan olarak 1000ms kullan. YanÄ±tÄ± JSON formatÄ±nda ver.`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { 
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "command": { "type": "STRING", "enum": ["Ä°leri", "Geri", "Sola DÃ¶n", "SaÄŸa DÃ¶n", "Durduruldu"] },
                                    "duration_ms": { "type": "INTEGER" }
                                },
                                "required": ["command"]
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedCommands = JSON.parse(jsonText); 
                    setStatus(robotStatusElement.textContent, 'Yol planÄ± baÅŸarÄ±yla oluÅŸturuldu. YÃ¼rÃ¼tÃ¼lÃ¼yor...');
                    await executeCommands(parsedCommands); 
                } else {
                    setStatus(robotStatusElement.textContent, 'Yol planÄ± oluÅŸturulamadÄ±. LÃ¼tfen tekrar deneyin.');
                    console.error('API yanÄ±t yapÄ±sÄ± beklenenden farklÄ±:', result);
                }
            } catch (error) {
                setStatus('Hata!', `API hatasÄ±: ${error.message}`);
                console.error('Yol planÄ± oluÅŸturulurken hata oluÅŸtu:', error);
            } finally {
                setButtonsDisabled(false);
            }
        }

        async function generateCreativeMovement() {
            setButtonsDisabled(true);
            setStatus(robotStatusElement.textContent, 'YaratÄ±cÄ± hareket Ã¶nerisi alÄ±nÄ±yor...');

            try {
                const prompt = `Bir robot iÃ§in 3-5 adÄ±mdan oluÅŸan kÄ±sa ve yaratÄ±cÄ± bir hareket dizisi oluÅŸtur. Her adÄ±m "Ä°leri", "Geri", "Sola DÃ¶n", "SaÄŸa DÃ¶n" veya "Durduruldu" komutlarÄ±ndan biri olmalÄ± ve her komut iÃ§in 500ms ile 2000ms arasÄ±nda rastgele bir 'duration_ms' (milisaniye cinsinden sÃ¼re) belirt. YanÄ±tÄ± JSON formatÄ±nda ver.`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { 
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "command": { "type": "STRING", "enum": ["Ä°leri", "Geri", "Sola DÃ¶n", "SaÄŸa DÃ¶n", "Durduruldu"] },
                                    "duration_ms": { "type": "INTEGER" }
                                },
                                "required": ["command", "duration_ms"]
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedCommands = JSON.parse(jsonText);
                    setStatus(robotStatusElement.textContent, 'YaratÄ±cÄ± hareket Ã¶nerisi alÄ±ndÄ±. YÃ¼rÃ¼tÃ¼lÃ¼yor...');
                    await executeCommands(parsedCommands);
                } else {
                    setStatus(robotStatusElement.textContent, 'YaratÄ±cÄ± hareket Ã¶nerisi oluÅŸturulamadÄ±. LÃ¼tfen tekrar deneyin.');
                    console.error('API yanÄ±t yapÄ±sÄ± beklenenden farklÄ±:', result);
                }
            } catch (error) {
                setStatus('Hata!', `API hatasÄ±: ${error.message}`);
                console.error('YaratÄ±cÄ± hareket oluÅŸturulurken hata oluÅŸtu:', error);
            } finally {
                setButtonsDisabled(false);
            }
        }
    </script>
</body>
</html>
